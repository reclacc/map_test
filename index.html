<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Карта с динамической подгрузкой 50 000 меток</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
        }
        #map { 
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
<div id="map"></div>

<script>
ymaps.ready(init);

let allPoints = [];
let clusterer;

// Генерация 50 000 случайных точек
function generatePoints(count) {
    const baseLat = 55.76;
    const baseLon = 37.64;
    const points = [];

    for (let i = 0; i < count; i++) {
        const lat = baseLat + (Math.random() - 0.5) * 0.2;
        const lon = baseLon + (Math.random() - 0.5) * 0.2;
        points.push([lat, lon]);
    }

    return points;
}

// Фильтр точек по области
function filterPointsInBounds(points, bounds) {
    const [southWest, northEast] = bounds;
    return points.filter(point => {
        const lat = point[0];
        const lon = point[1];
        return (
            lat >= southWest[0] &&
            lat <= northEast[0] &&
            lon >= southWest[1] &&
            lon <= northEast[1]
        );
    });
}

// Добавление меток на карту
function updateMapWithVisiblePoints(bounds) {
    const filtered = filterPointsInBounds(allPoints, bounds);
    
    // Очистка предыдущих данных
    clusterer.removeAll();

    // Добавляем новые метки
    filtered.forEach(coords => {
        const placemark = new ymaps.Placemark(coords, {
            hintContent: 'Метка',
            balloonContent: `
                <img src="https://www.shutterstock.com/image-photo/kitten-listens-music-earphones-on-600nw-1416534950.jpg" 
                     width="150"
                     alt="Котёнок">
            `,
        });

        clusterer.add(placemark);
    });
}

function init(map) {
    const myMap = new ymaps.Map("map", {
        center: [55.76, 37.64],
        zoom: 10,
        controls: ['zoomControl']
    });

    // Создаём кластеризатор
    clusterer = new ymaps.Clusterer({
        preset: 'islands#invertedVioletClusterIcons',
        groupByCoordinates: false,
        clusterDisableClickZoom: true,
        clusterOpenBalloonOnClick: false
    });

    myMap.geoObjects.add(clusterer);

    // Генерируем данные
    allPoints = generatePoints(50000);

    // Первичная загрузка меток
    const initialBounds = myMap.getBounds();
    updateMapWithVisiblePoints(initialBounds);

    // Обновляем при изменении области карты
    myMap.events.add('boundschange', function (e) {
        const bounds = e.get('newCenter') && e.get('newZoom') ? myMap.getBounds() : null;
        if (bounds) {
            updateMapWithVisiblePoints(bounds);
        }
    });
}
</script>
</body>
</html>
